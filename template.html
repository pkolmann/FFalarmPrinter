<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FF Pitten Einsatzplan</title>
    <link href="../template.css" rel="stylesheet" type="text/css" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

    <script type="text/javascript">

        // src: https://valhalla.github.io/demos/polyline/decode.js
        //decode an encoded string
        function decode(encoded) {
            //precision
            var inv = 1.0 / 1e5;
            var decoded = [];
            var previous = [0,0];
            var i = 0;
            //for each byte
            while(i < encoded.length) {
                //for each coord (lat, lon)
                var ll = [0,0]
                for(var j = 0; j < 2; j++) {
                    var shift = 0;
                    var byte = 0x20;
                    //keep decoding bytes until you have this coord
                    while(byte >= 0x20) {
                        byte = encoded.charCodeAt(i++) - 63;
                        ll[j] |= (byte & 0x1f) << shift;
                        shift += 5;
                    }
                    //add previous offset to get final value and remember for next one
                    ll[j] = previous[j] + (ll[j] & 1 ? ~(ll[j] >> 1) : (ll[j] >> 1));
                    previous[j] = ll[j];
                }
                //scale by precision and chop off long coords
                decoded.push([ll[0] * inv,ll[1] * inv]);
            }
            //hand back the list of coordinates
            return decoded;
        };

        function initialize() {
            const startLat = @@STARTLAT@@;
            const startLong = @@STARTLONG@@;
            const endLat = @@ENDLAT@@;
            const endLong = @@ENDLONG@@;
            const routeJson = @@ROUTEJSON@@;
            const hydrantsJson = @@HYDRANTSJSON@@;
            const routeSteps = @@ROUTESTEPS@@;

            let mapZoom = 13;
            if (
                routeJson.hasOwnProperty("routes")
                && routeJson.routes.hasOwnProperty(0)
                && routeJson.routes[0].hasOwnProperty("distance")
                && routeJson.routes[0].hasOwnProperty("duration")
            ) {
                const totalDistance = routeJson.routes[0].distance;
                let totalDuration = routeJson.routes[0].duration;

                if (totalDistance > 0 && totalDistance < 5000) {
                    mapZoom = 16;
                } else if (totalDistance < 10000) {
                    mapZoom = 15;
                } else if (totalDistance < 20000) {
                    mapZoom = 14;
                }

                const anfahrt = document.getElementById("einsatz-anfahrt-data");
                anfahrt.innerHTML  = Math.round(totalDistance / 10) / 100;
                anfahrt.innerHTML += "km - ungef&auml;hr ";
                if (totalDuration > 3600) {
                    const hours = Math.floor(totalDuration / 3600);
                    totalDuration = hours % 3600;
                    anfahrt.innerHTML += hours + " Stunden ";
                }
                if (totalDuration > 60) {
                    const mins = Math.round(totalDuration / 60);
                    anfahrt.innerHTML += mins + " Minuten";
                } else {
                    anfahrt.innerHTML += "1 Minute";
                }

                if (routeSteps !== null) {
                    let routeDescription = "<h2>Routenbeschreibung</h2><ul>";
                    for (let i = 0; i < routeSteps.length; i++) {
                        routeDescription += "<li>" + routeSteps[i].text;
                        if (i < (routeSteps.length - 1)) {
                            routeDescription += " (" + routeSteps[i].distance + "m)";
                        }
                        routeDescription += "</li>";
                    }
                    routeDescription += "</ul>";
                    document.getElementById("directionsPanel").innerHTML = routeDescription;
                }

                if (totalDistance >= 10000) {
                    document.getElementById("directionsPanel").style.display = "block";
                    document.getElementById("directionsPanel").style.pageBreakBefore = "always";
                }
            }

            const map = L.map('map').setView([endLat, endLong], mapZoom);
            const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 20,
                attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributers'
            }).addTo(map);

            // Add hydrants to map first, so other layers are infront
            for (const i in hydrantsJson) {
                console.log(hydrantsJson[i]);
                const hydrantMarker = new L.Marker(
                    [hydrantsJson[i].Lat, hydrantsJson[i].Lon],
                    {
                        title: hydrantsJson[i].text.replaceAll("<br />", "\n")
                    }
                ).addTo(map);

                // https://stackoverflow.com/a/61982880
                hydrantMarker._icon.classList.add("hydrantHue");
            }

            // Add Route geometry to map
            if (
                routeJson.hasOwnProperty("routes")
                && routeJson.routes.hasOwnProperty(0)
                && routeJson.routes[0].hasOwnProperty("geometry")
            ) {
                console.log("geometry: " + routeJson.routes[0].geometry);
                const routeLine = L.polyline(decode(routeJson.routes[0].geometry), {
                    color: "blue"
                }).addTo(map);
            }


            // Add Start Pin
            const startMarker = new L.Marker(
                [startLat, startLong],
                {
                    title: "Feuerwehr Pitten"
                }
            ).addTo(map);
            startMarker._icon.classList.add("startHue");

            // Add End Pin
            const endMarker = new L.Marker(
                [endLat, endLong],
                {
                    title: "Einsatzort"
                }
            ).addTo(map);
            // https://stackoverflow.com/a/61982880
            endMarker._icon.classList.add("endHue");

        }
    </script>
</head>
<body onload="initialize()">
<div id="page" class="page" style="">
    <div id="back-link">
        <a href="../archiv.html">Zum Archiv</a> | <a href="../index.html">Zum Index</a>
    </div>
    <div id="header">
        <h1>FF Pitten Einsatzplan</h1>
    </div>
    <div id="einsatzdaten" style="">
        <div class="inputliste">
            @@INPUTLISTE@@
            <div class="zeile" id="einsatz-anfahrt">
                <div class="links">
                    Wegstrecke:
                </div>
                <div class="rechts" id="einsatz-anfahrt-data">
                </div>
            </div>
        </div>
    </div>
    <div id="map"></div>
    <div id="directionsPanel" style=""></div>
</div>
</body>
</html>
